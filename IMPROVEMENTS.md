# RAG 챗봇 답변 품질 개선 사항 (v2.3)

## 📊 개선 요약
현재 RAG 시스템의 답변 품질을 향상시키기 위해 파라미터, 프롬프트, 기능을 총체적으로 개선했습니다.

---

## 1️⃣ 파라미터 최적화

### 청크 분할 개선
| 파라미터 | 이전 | 개선후 | 효과 |
|---------|------|-------|------|
| `CHUNK_SIZE` | 800 | **1000** | 더 풍부한 맥락 정보 포함 |
| `CHUNK_OVERLAP` | 120 | **200** | 청크 간 문맥 연결성 강화 |

**효과**: 너무 짧지도, 너무 길지도 않은 최적의 정보 단위로 분할

### 검색 품질 개선
| 파라미터 | 이전 | 개선후 | 효과 |
|---------|------|-------|------|
| `RETRIEVER_K` | 6 | **10** | LLM이 더 많은 근거 활용 |
| `RETRIEVER_FETCH_K` | 40 | **60** | 다양한 후보에서 선택 |
| `RETRIEVER_LAMBDA` | 0.5 | **0.6** | 유사도 비중 상향 (안정성↑) |

**효과**: 정확하면서도 다양한 답변 근거 제공

### LLM 생성 개선
| 파라미터 | 이전 | 개선후 | 효과 |
|---------|------|-------|------|
| `TEMPERATURE` | 0 | **0.1** | 자연스러운 한국어 표현 |

**효과**: 딱딱한 기계적 답변 → 읽기 좋은 자연스러운 한국어

---

## 2️⃣ 프롬프트 엔지니어링

### (1) Q&A 프롬프트 개선
**변경 사항**:
- ✅ 존댓말 → 존경어 사용 (전문성 강화)
- ✅ 명확한 단계별 출력 형식 정의
- ✅ "질문 재구성" 섹션 추가 → 의도 파악 명확화
- ✅ "확인하면 좋은 추가 정보" 섹션 추가 → 액션 아이템 제시
- ✅ 근거 제시 방식 표준화

**결과**: 더 구조화되고 실무적인 답변

**예시 출력 형식**:
```
## 질문 재구성
(질문의 실제 목적과 의도)

## 핵심 답변
(가장 중요한 정보)

## 상세 설명
- 항목1
- 항목2

## 근거 (출처 명시)
- p.번호: (해당 내용 요약)

## 확인하면 좋은 추가 정보
- 체크포인트 1
- 체크포인트 2
```

### (2) 요약 프롬프트 개선
- ✅ 이모지를 활용한 섹션 강조
- ✅ "핵심 요약" → "상세 정리" 계층 분화
- ✅ 사용자 관점 중심 정보 정렬

### (3) 페이지별 요약 프롬프트 개선
- ✅ 명확한 구조 제시
- ✅ 규정/절차/주의사항 강조
- ✅ 핵심 3가지 우선 제시

---

## 3️⃣ 새로운 고급 기능

### 🔄 쿼리 확장 (Query Expansion)
**기능**: 사용자의 원본 질문을 5가지 관점에서 재구성
```python
query_expansion(query: str) -> list[str]
```

**활용 범위**:
1. 직설적 표현 (더 명확하게)
2. 관련 개념 포함 (동의어/유사 개념)
3. 배경/맥락 강화 (why/how 추가)
4. 실무 관점 (실제 업무 상황)
5. 역질문 (핵심 의도 역표현)

**효과**: 
- ✅ 검색 정확도 향상
- ✅ 모호한 질문 처리 개선
- ⚠️ 응답 시간 증가 (선택 사항)

### 📈 재정렬 (Re-ranking)
**기능**: LLM이 검색된 문서를 관련도 순으로 재정렬
```python
rerank_results(query: str, retrieved_docs: list) -> list
```

**효과**:
- ✅ 가장 관련도 높은 정보를 LLM이 우선 활용
- ✅ 답변 정확도 향상

### ✅ 신뢰도 표시 (Confidence Score)
**기능**: 답변 위에 신뢰도 배지 표시
```python
add_confidence_score(response: str, context_quality: float) -> str
```

**신뢰도 레벨**:
- ✅ **높음** (context_quality > 0.8): "충분한 문서 근거"
- ⚠️ **중간** (0.5 ~ 0.8): "제한된 근거"
- ❌ **낮음** (< 0.5): "불충분한 근거"

**효과**:
- ✅ 사용자가 답변의 신뢰도를 한눈에 판단
- ✅ 거짓 정보(hallucination) 위험 낮춤

---

## 4️⃣ UI/UX 개선 (app.py)

### 고급 옵션 메뉴 추가
```
⚙️ 시스템 설정
  ├─ 출처 근거 강조 표시 (기존)
  ├─ 대화 기록 유지 (기존)
  └─ 🆕 고급 옵션 (펼칠 수 있음)
      ├─ 쿼리 확장 활성화
      └─ 신뢰도 표시
```

**이점**:
- 기본 사용자: 간단한 인터페이스
- 고급 사용자: 성능 최적화 옵션 제공

---

## 5️⃣ 라이브러리 업데이트

### requirements.txt 개선
```
✅ langchain>=0.2.0      (버전 명시로 안정성)
✅ openai>=1.0.0         (최신 OpenAI API)
✅ numpy>=1.24.0         (성능 계산용)
✨ faiss-gpu 옵션       (GPU 가속 선택사항)
```

---

## 🎯 기대 효과

| 개선 항목 | 기대 효과 |
|---------|---------|
| 파라미터 최적화 | 답변 정확도 ↑↑, 근거 품질 ↑ |
| 프롬프트 개선 | 이해도 ↑↑, 액션 아이템 명확화 |
| 쿼리 확장 | 검색 정확도 ↑↑ (선택 사용) |
| 신뢰도 표시 | 사용자 신뢰도 ↑↑ |
| UI 개선 | 사용성 ↑, 옵션 제어성 ↑ |

---

## 🚀 사용 방법

### 기본 사용 (변경 없음)
1. PDF 업로드
2. 질문 입력
3. 답변 확인

### 고급 옵션 활성화
1. 사이드바 "고급 옵션" 펼치기
2. "쿼리 확장 활성화" 체크 (더 정확한 답변 원할 때)
3. "신뢰도 표시" 체크 (근거 신뢰도 확인)
4. 질문 입력

### 수동 파라미터 조정
[rag_module.py](rag_module.py#L17) 상단의 파라미터를 직접 수정:
```python
CHUNK_SIZE = 1000       # 1000~1200 권장
CHUNK_OVERLAP = 200     # 150~250 권장
RETRIEVER_K = 10        # 8~15 권장
RETRIEVER_LAMBDA = 0.6  # 0.5~0.8 권장
TEMPERATURE = 0.1       # 0.0~0.3 권장
```

---

## 📌 주의사항

⚠️ **응답 시간**: 쿼리 확장 활성화 시 응답 시간이 4~5배 증가할 수 있습니다.
- 중요한 질문: 쿼리 확장 ON
- 빠른 피드백 필요: 쿼리 확장 OFF (기본값)

⚠️ **API 비용**: TEMPERATURE 상향 및 추가 API 호출로 비용이 약간 증가합니다.

✅ **벡터 DB 캐싱**: 같은 PDF를 반복 사용할 때는 FAISS 인덱스를 저장하여 재사용하는 것이 좋습니다.

---

## 🔮 향후 개선 로드맵

- [ ] FAISS 인덱스 캐싱 (반복 사용 성능 ↑)
- [ ] 하이브리드 검색 (BM25 + 벡터 검색)
- [ ] 문서 메타데이터 활용 (작성자, 날짜 필터링)
- [ ] 대화 메모리 (Multi-turn 질답 개선)
- [ ] 로컬 임베딩 모델 (비용 절감)
- [ ] 응답 평가 메커니즘 (자동 품질 측정)

---

**마지막 업데이트**: 2026년 1월 26일
**버전**: v2.3
